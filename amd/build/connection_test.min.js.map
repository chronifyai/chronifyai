{"version":3,"file":"connection_test.min.js","sources":["../src/connection_test.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Connection test module for ChronifyAI configuration wizard.\n *\n * @module     local_chronifyai/connection_test\n * @copyright  2025 SEBALE Innovations (http://sebale.net)\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Notification from 'core/notification';\nimport {verifyConnection} from \"./repository\";\n\n/**\n * Initialize the connection test functionality.\n *\n * @param {string} buttonSelector The selector for the test connection button\n */\nexport const init = (buttonSelector = '#test-connection-btn') => {\n    const testButton = document.querySelector(buttonSelector);\n\n    if (!testButton) {\n        return;\n    }\n\n    testButton.addEventListener('click', async(event) => {\n        event.preventDefault();\n        await handleTestConnection(testButton);\n    });\n};\n\n/**\n * Handle the test connection button click.\n *\n * @param {HTMLElement} button The test connection button\n */\nconst handleTestConnection = async(button) => {\n    // Get form values.\n    const apiBaseUrl = document.querySelector('input[name=\"api_base_url\"]')?.value || '';\n    const clientId = document.querySelector('input[name=\"client_id\"]')?.value || '';\n    const clientSecret = document.querySelector('input[name=\"client_secret\"]')?.value || '';\n\n    // Get result container.\n    const resultContainer = document.querySelector('#connection-result');\n\n    if (!resultContainer) {\n        return;\n    }\n\n    // Validate inputs.\n    if (!apiBaseUrl || !clientId || !clientSecret) {\n        showResult(resultContainer, false, 'All fields are required for connection testing.');\n        return;\n    }\n\n    // Show loading state.\n    button.disabled = true;\n    const originalText = button.textContent;\n    button.textContent = 'Testing...';\n\n    // Show loading message.\n    resultContainer.classList.remove('success', 'error');\n    resultContainer.classList.add('loading');\n    resultContainer.innerHTML = '<span class=\"icon\">⏳</span> Testing connection...'; // TODO: use language strings.\n\n    try {\n        // Call the repository function.\n        const result = await verifyConnection(apiBaseUrl, clientId, clientSecret);\n\n        // Show result.\n        showResult(resultContainer, result.success, result.message);\n    } catch (error) {\n        // Show error notification.\n        showResult(resultContainer, false, 'An unexpected error occurred: ' + error.message);\n        await Notification.exception(error);\n    } finally {\n        // Reset button state.\n        button.disabled = false;\n        button.textContent = originalText;\n    }\n};\n\n/**\n * Display the connection test result.\n *\n * @param {HTMLElement} container The result container element\n * @param {boolean} success Whether the test was successful\n * @param {string} message The result message\n */\nconst showResult = (container, success, message) => {\n    // Remove all state classes.\n    container.classList.remove('success', 'error', 'loading');\n\n    // Add appropriate state class.\n    container.classList.add(success ? 'success' : 'error');\n\n    // Set icon based on success/failure.\n    const icon = success ? '✓' : '✗';\n\n    // Update content.\n    container.innerHTML = `<span class=\"icon\">${icon}</span> ${escapeHtml(message)}`;\n};\n\n/**\n * Escape HTML to prevent XSS.\n *\n * @param {string} text The text to escape\n * @returns {string} The escaped text\n */\nconst escapeHtml = (text) => {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n};\n"],"names":["buttonSelector","testButton","document","querySelector","addEventListener","async","event","preventDefault","handleTestConnection","apiBaseUrl","value","clientId","clientSecret","resultContainer","showResult","button","disabled","originalText","textContent","classList","remove","add","innerHTML","result","success","message","error","Notification","exception","container","icon","escapeHtml","text","div","createElement"],"mappings":";;;;;;;oKA+BoB,eAACA,sEAAiB,6BAC5BC,WAAaC,SAASC,cAAcH,gBAErCC,YAILA,WAAWG,iBAAiB,SAASC,MAAAA,QACjCC,MAAMC,uBACAC,qBAAqBP,sBAS7BO,qBAAuBH,MAAAA,uFAEnBI,0CAAaP,SAASC,cAAc,4FAA+BO,QAAS,GAC5EC,yCAAWT,SAASC,cAAc,2FAA4BO,QAAS,GACvEE,6CAAeV,SAASC,cAAc,+FAAgCO,QAAS,GAG/EG,gBAAkBX,SAASC,cAAc,0BAE1CU,2BAKAJ,aAAeE,WAAaC,yBAC7BE,WAAWD,iBAAiB,EAAO,mDAKvCE,OAAOC,UAAW,QACZC,aAAeF,OAAOG,YAC5BH,OAAOG,YAAc,aAGrBL,gBAAgBM,UAAUC,OAAO,UAAW,SAC5CP,gBAAgBM,UAAUE,IAAI,WAC9BR,gBAAgBS,UAAY,8DAIlBC,aAAe,gCAAiBd,WAAYE,SAAUC,cAG5DE,WAAWD,gBAAiBU,OAAOC,QAASD,OAAOE,SACrD,MAAOC,OAELZ,WAAWD,iBAAiB,EAAO,iCAAmCa,MAAMD,eACtEE,sBAAaC,UAAUF,eAG7BX,OAAOC,UAAW,EAClBD,OAAOG,YAAcD,eAWvBH,WAAa,CAACe,UAAWL,QAASC,WAEpCI,UAAUV,UAAUC,OAAO,UAAW,QAAS,WAG/CS,UAAUV,UAAUE,IAAIG,QAAU,UAAY,eAGxCM,KAAON,QAAU,IAAM,IAG7BK,UAAUP,uCAAkCQ,wBAAeC,WAAWN,WASpEM,WAAcC,aACVC,IAAM/B,SAASgC,cAAc,cACnCD,IAAIf,YAAcc,KACXC,IAAIX"}